Public Function ReadMappingFromTableName(mapTableName As String) As Boolean
    On Error GoTo FAIL

    Dim lo As ListObject
    Set lo = GetListObjectByNameLocal(mapTableName)
    If lo Is Nothing Then
        MsgBox "Mappingテーブルが見つかりません: " & mapTableName, vbCritical
        ReadMappingFromTableName = False: Exit Function
    End If
    If lo.DataBodyRange Is Nothing Then
        MsgBox "Mappingテーブルにデータ行がありません: " & mapTableName, vbExclamation
        ReadMappingFromTableName = False: Exit Function
    End If

    '--- ヘッダー列の位置解決 ---
    Dim cNo As Long, cOut As Long, cType As Long, cKey As Long, cMode As Long
    Dim cDefId As Long

    cNo    = FindHeaderIndexLocal(lo, "No")                         ' 任意（存在すれば読む）
    cOut   = FindHeaderIndexLocal(lo, "出力カラム")
    If cOut = 0 Then cOut = FindHeaderIndexLocal(lo, "出力カラム名") ' 互換
    cType  = FindHeaderIndexLocal(lo, "データ型")
    cKey   = FindHeaderIndexLocal(lo, "キー")
    cMode  = FindHeaderIndexLocal(lo, "モード")
    cDefId = FindHeaderIndexLocal(lo, "定義ID")                     ' 必須（ただしVALUE行は空OK）

    If cOut = 0 Or cType = 0 Or cKey = 0 Or cMode = 0 Or cDefId = 0 Then
        MsgBox "Mappingの見出しに不足があります（出力カラム／データ型／キー／モード／定義ID）", vbCritical
        ReadMappingFromTableName = False: Exit Function
    End If

    '--- 元テーブル名の開始位置を決定（固定列の最大の右隣） ---
    Dim maxFixed As Long
    maxFixed = Application.WorksheetFunction.Max(ArrayNZ(cNo), cOut, cType, cKey, cMode, cDefId)
    If maxFixed < 1 Then maxFixed = 6
    Dim firstColTable As Long: firstColTable = maxFixed + 1

    '--- ヘッダーから元テーブル名一覧を収集（空セルで打ち切り） ---
    Dim lastHeaderCol As Long: lastHeaderCol = lo.HeaderRowRange.Columns.Count
    Dim tn As String, dyn As New Collection
    Dim i As Long
    For i = firstColTable To lastHeaderCol
        tn = Trim$(CStr(lo.HeaderRowRange.Cells(1, i).Value))
        If Len(tn) = 0 Then Exit For
        dyn.Add tn
    Next
    If dyn.Count = 0 Then
        MsgBox "Mappingに元テーブル（定義ID列の右側）の見出しがありません。", vbCritical
        ReadMappingFromTableName = False: Exit Function
    End If

    '--- 配列確保 ---
    Dim rows As Long, cols As Long, t As Long, r As Long
    rows = lo.DataBodyRange.Rows.Count
    cols = dyn.Count

    ReDim Map_No(1 To rows)
    ReDim Map_OutCols(1 To rows)
    ReDim Map_DataType(1 To rows)
    ReDim Map_Key(1 To rows)
    ReDim Map_Mode(1 To rows)
    ReDim Map_Def(1 To rows)
    ReDim Map_TblNames(1 To cols)
    ReDim Map_SrcCols(1 To rows, 1 To cols)

    For t = 1 To cols
        Map_TblNames(t) = CStr(dyn(t))
    Next

    '--- 本体読み込み ---
    Dim body As Range: Set body = lo.DataBodyRange
    Dim defId As String, defText As String, modeVal As String

    For r = 1 To rows
        If cNo > 0 Then Map_No(r) = body.Cells(r, cNo).Value
        Map_OutCols(r)  = Trim$(CStr(body.Cells(r, cOut).Value))
        Map_DataType(r) = UCase$(Trim$(CStr(body.Cells(r, cType).Value)))
        Map_Key(r)      = UCase$(Trim$(CStr(body.Cells(r, cKey).Value)))
        Map_Mode(r)     = UCase$(Trim$(CStr(body.Cells(r, cMode).Value)))

        modeVal = Map_Mode(r)
        defId = Trim$(CStr(body.Cells(r, cDefId).Value))

        If Len(defId) = 0 Then
            If modeVal = "VALUE" Then
                defText = ""   ' VALUEは加工なし（Definitions参照不要）
            Else
                MsgBox "定義IDが未入力ですが、モード=" & modeVal & " の行があります。" & vbCrLf & _
                       "No=" & CStr(IIf(cNo > 0, body.Cells(r, cNo).Value, r)), vbCritical
                ReadMappingFromTableName = False: Exit Function
            End If
        Else
            On Error GoTo DEF_ERR
            defText = BuildDefinitionFromSheet(defId)   ' Definitionsから復元
            On Error GoTo FAIL
        End If

        Map_Def(r) = defText

        ' 元カラム群
        For t = 1 To cols
            Map_SrcCols(r, t) = CStr(body.Cells(r, firstColTable - 1 + t).Value)
        Next
    Next r

    ReadMappingFromTableName = True
    Exit Function

DEF_ERR:
    MsgBox "Definitions参照に失敗しました。定義ID=" & defId & " / " & Err.Description, vbCritical
    ReadMappingFromTableName = False
    Exit Function

FAIL:
    MsgBox "ReadMappingFromTableName でエラー: " & Err.Description, vbCritical
    ReadMappingFromTableName = False
End Function