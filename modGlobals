Option Explicit
'============================================================
' modGlobals
' 概要: 定数・共有状態（エンコード、パイプライン設定、読み込みテーブル、マッピング配列など）を保持します。
'============================================================

' グローバル定数・共有変数
Public Const IMPORT_FOLDER As String = "importFiles"   ' 入力フォルダ
Public Const EXPORT_FOLDER As String = "exportFiles"   ' 出力フォルダ
Public Const LOG_FOLDER    As String = "log"           ' ログフォルダ

' エンコード（AUTO/UTF-8/SHIFT_JIS/UTF-16LE）
Public CurrentEncodingMode As String

' パイプライン（Main / List）
Public CurrentMappingTableName As String
Public CurrentMasterTableName  As String
Public CurrentExportBaseName   As String

' 1対多を展開するか（List パイプラインで True）
Public AllowOneToMany As Boolean

' 読み込んだ各テーブル（CSV）の2次元配列（Key: テーブル名）
Public TableData As Object

' JOIN 用のキー索引
Public KeyIndexSingle As Object
Public KeyIndexMulti  As Object

' 無加工JOIN済みの中間データ
Public RawJoined As Variant
Public HasRaw As Boolean
Public IsProcessed As Boolean

' Mappingキャッシュ
Public Map_OutCols()  As String
Public Map_DataType() As String
Public Map_IsKey()    As Boolean
Public Map_Mode()     As String
Public Map_Def()      As String
Public Map_TblNames() As String
Public Map_SrcCols    As Variant

' JOIN再構築で使うベース情報
Public m_baseTblName As String
Public m_baseRowIdx() As Long

'=== 追加：インポート時はモードを無視するフラグ ===
Public IgnoreModeOnImport As Boolean

' 共通関数

'--- TimeStamp ---
' 概要: 現在日時を 'yyyymmddhhmmss' 形式の文字列で返します。
' 戻り値: タイムスタンプ文字列（例: 20251027xxxxxx）
Public Function TimeStamp() As String
    TimeStamp = Format(Now, "yyyymmddhhmmss")
End Function

'--- IsArrayInitialized ---
' 概要: Variant が配列として初期化済みかを安全に判定します（未確保/未初期化配列は False）。
' 引数:
'   ByVal v As Variant  … 判定対象
' 戻り値: True: 配列で LBound 参照に成功 / False: それ以外
Public Function IsArrayInitialized(ByVal v As Variant) As Boolean
    On Error GoTo EH
    If IsArray(v) Then
        Dim lb As Long
        lb = LBound(v, 1)
        IsArrayInitialized = True
        Exit Function
    End If
EH:
    IsArrayInitialized = False
End Function

'--- IsAllocated_Long ---
' 概要: Long 配列が確保済みかを安全に判定します（未確保/未初期化配列は False）。
' 引数:
'   ByRef arr() As Long  … 判定対象の Long 配列
' 戻り値: True: 配列で LBound 参照に成功 / False: それ以外
Public Function IsAllocated_Long(ByRef arr() As Long) As Boolean
    On Error GoTo EH
    Dim lb As Long
    lb = LBound(arr, 1)
    IsAllocated_Long = True
    Exit Function
EH:
    IsAllocated_Long = False
End Function