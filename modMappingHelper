Option Explicit
'============================================================
' modMappingHelper (JoinKey対応版・重複定義なし)
'============================================================

'=== JoinKey（列ごとLEFT JOIN指定） ===
Public Map_JoinSpec() As String

'=== 既存公開配列（互換） ===
Public Map_No() As Variant
Public Map_OutCols() As String
Public Map_DataType() As String
Public Map_Key() As String
Public Map_Mode() As String
Public Map_Def() As String
Public Map_IsKey() As Boolean
Public Map_TblNames() As String           ' 1次元: 参照テーブル名の並び
Public Map_SrcCols() As String            ' 2次元: (行, テーブルIndex) → 列名

'=== 外部共有（他モジュール参照） ===
Public TableData As Object
Public KeyIndexSingle As Object
Public KeyIndexMulti As Object

'==============================
' Mapping読み込み本体（見出し名ベース、JoinKey列は任意）
'==============================
Public Function ReadMappingFromTableName(mappingTableName As String) As Boolean
    On Error GoTo FAIL

    Dim lo As ListObject
    Set lo = GetListObjectByNameLocal(mappingTableName)
    If lo Is Nothing Then
        MsgBox "Mappingテーブルが見つかりません: " & mappingTableName, vbCritical
        ReadMappingFromTableName = False: Exit Function
    End If
    If lo.DataBodyRange Is Nothing Then
        MsgBox "Mappingテーブルにデータ行がありません: " & mappingTableName, vbExclamation
        ReadMappingFromTableName = False: Exit Function
    End If

    '--- 必須見出しの列位置 ---
    Dim cNo As Long, cOut As Long, cType As Long, cKey As Long, cMode As Long, cDefId As Long, cJoin As Long
    cNo = FindHeaderIndexLocal(lo, "No")
    cOut = FindHeaderIndexLocal(lo, "出力カラム"): If cOut = 0 Then cOut = FindHeaderIndexLocal(lo, "出力カラム名")
    cType = FindHeaderIndexLocal(lo, "データ型")
    cKey = FindHeaderIndexLocal(lo, "キー")
    cMode = FindHeaderIndexLocal(lo, "モード")
    cDefId = FindHeaderIndexLocal(lo, "定義ID")
    cJoin = FindHeaderIndexLocal(lo, "JoinKey") ' 任意

    If cOut = 0 Or cType = 0 Or cKey = 0 Or cMode = 0 Or cDefId = 0 Then
        MsgBox "Mappingの必須見出し（出力カラム/データ型/キー/モード/定義ID）が不足しています。", vbCritical
        ReadMappingFromTableName = False: Exit Function
    End If

    '--- 元テーブル見出しの開始位置（固定列の最大の右隣） ---
    Dim maxFixed As Long
    maxFixed = Application.WorksheetFunction.Max(ArrayNZ(cNo), cOut, cType, cKey, cMode, cDefId, ArrayNZ(cJoin))
    If maxFixed < 1 Then maxFixed = 6
    Dim firstColTable As Long: firstColTable = maxFixed + 1

    '--- 元テーブル名の見出し群を収集（空セルで打ち切り） ---
    Dim dyn As New Collection, i As Long, tn As String
    For i = firstColTable To lo.HeaderRowRange.Columns.Count
        tn = Trim$(CStr(lo.HeaderRowRange.Cells(1, i).Value))
        If Len(tn) = 0 Then Exit For
        dyn.Add tn
    Next
    If dyn.Count = 0 Then
        MsgBox "Mapping右側に『元テーブル名』の見出しがありません。", vbCritical
        ReadMappingFromTableName = False: Exit Function
    End If

    '--- 配列確保 ---
    Dim rows As Long, cols As Long, r As Long, t As Long
    rows = lo.DataBodyRange.Rows.Count
    cols = dyn.Count

    ReDim Map_No(1 To rows)
    ReDim Map_OutCols(1 To rows)
    ReDim Map_DataType(1 To rows)
    ReDim Map_Key(1 To rows)
    ReDim Map_Mode(1 To rows)
    ReDim Map_Def(1 To rows)
    ReDim Map_IsKey(1 To rows)
    ReDim Map_JoinSpec(1 To rows)         ' ★ JoinKey
    ReDim Map_TblNames(1 To cols)
    ReDim Map_SrcCols(1 To rows, 1 To cols)

    For t = 1 To cols
        Map_TblNames(t) = CStr(dyn(t))
    Next

    '--- 本体読み取り ---
    Dim body As Range: Set body = lo.DataBodyRange
    Dim defId As String, defText As String, modeVal As String

    For r = 1 To rows
        If cNo > 0 Then Map_No(r) = body.Cells(r, cNo).Value
        Map_OutCols(r) = Trim$(CStr(body.Cells(r, cOut).Value))
        Map_DataType(r) = UCase$(Trim$(CStr(body.Cells(r, cType).Value)))
        Map_Key(r) = Trim$(CStr(body.Cells(r, cKey).Value))
        Map_Mode(r) = UCase$(Trim$(CStr(body.Cells(r, cMode).Value)))
        Map_JoinSpec(r) = IIf(cJoin > 0, Trim$(CStr(body.Cells(r, cJoin).Value)), "")

        Map_IsKey(r) = IsKeyTrue(Map_Key(r))

        modeVal = Map_Mode(r)
        defId = Trim$(CStr(body.Cells(r, cDefId).Value))
        If Len(defId) = 0 Then
            If modeVal = "VALUE" Then
                defText = ""
            Else
                MsgBox "定義IDが未入力ですが、モード=" & modeVal & " の行があります。（行=" & CStr(IIf(cNo > 0, body.Cells(r, cNo).Value, r)) & "）", vbCritical
                ReadMappingFromTableName = False: Exit Function
            End If
        Else
            On Error GoTo DEF_ERR
            defText = BuildDefinitionFromSheet(defId)
            On Error GoTo FAIL
        End If
        Map_Def(r) = defText

        ' 元カラム群
        For t = 1 To cols
            Map_SrcCols(r, t) = CStr(body.Cells(r, firstColTable - 1 + t).Value)
        Next
    Next r

    ReadMappingFromTableName = True
    Exit Function

DEF_ERR:
    MsgBox "Definitions参照に失敗しました。定義ID=" & defId & " / " & Err.Description, vbCritical
    ReadMappingFromTableName = False
    Exit Function

FAIL:
    MsgBox "ReadMappingFromTableName エラー: " & Err.Description, vbCritical
    ReadMappingFromTableName = False
End Function

'==================== ヘルパ ====================
Private Function GetListObjectByNameLocal(nameOrRange As String) As ListObject
    Dim ws As Worksheet, lo As ListObject
    For Each ws In ThisWorkbook.Worksheets
        For Each lo In ws.ListObjects
            If StrComp(lo.Name, nameOrRange, vbTextCompare) = 0 Then
                Set GetListObjectByNameLocal = lo
                Exit Function
            End If
        Next
    Next
    Set GetListObjectByNameLocal = Nothing
End Function

Private Function FindHeaderIndexLocal(lo As ListObject, headerName As String) As Long
    Dim i As Long, s As String
    For i = 1 To lo.HeaderRowRange.Columns.Count
        s = Trim$(CStr(lo.HeaderRowRange.Cells(1, i).Value))
        If StrComp(s, headerName, vbTextCompare) = 0 Then
            FindHeaderIndexLocal = i: Exit Function
        End If
    Next
    FindHeaderIndexLocal = 0
End Function

Private Function ArrayNZ(v As Variant) As Long
    If IsNumeric(v) Then ArrayNZ = CLng(v) Else ArrayNZ = 0
End Function

Private Function IsKeyTrue(ByVal s As String) As Boolean
    Dim k As String
    k = UCase$(Trim$(s))
    k = Replace$(k, "〇", "○")
    If k = "○" Or k = "◯" Or k = "●" Then IsKeyTrue = True: Exit Function
    If k = "1" Or k = "Y" Or k = "YES" Or k = "TRUE" Or k = "ＴＲＵＥ" Then IsKeyTrue = True: Exit Function
    IsKeyTrue = False
End Function
